# ~/.bashrc: executed by bash(1) for non-login shells (Linux/Unix)
#
# IMPORTANT: On Linux/Unix, this file should be placed as ~/.bashrc
# Most Linux distributions source .bashrc for interactive non-login shells
# To install: copy this file to ~/.bashrc
#
# This configuration is optimized for Linux/Unix systems

# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac

# Shell options (comprehensive set for Linux)
shopt -s histappend
shopt -s checkwinsize
shopt -s cdspell
shopt -s cmdhist
shopt -s dotglob
shopt -s extglob
shopt -s nocaseglob

# History configuration (optimized for productivity)
HISTSIZE=10000
HISTFILESIZE=20000
HISTCONTROL=ignoreboth:erasedups
HISTIGNORE="ls:ll:la:cd:pwd:exit:clear:history"
HISTTIMEFORMAT="%F %T "

# Environment variables
export EDITOR=vim
export VISUAL=vim
export PAGER=less
export LESS='-R -i -M -W -q'

# Color support for less (man pages)
export LESS_TERMCAP_mb=$'\E[1;32m'
export LESS_TERMCAP_md=$'\E[1;32m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;47;34m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[1;36m'

# Prompt configuration (Linux optimized)
git_info=""

# Get system stats (fast Git branch detection)
function get_system_stats {
    git_info=""
    
    # Fast Git branch detection
    local headfile head branch
    local dir="$PWD"
    
    while [ -n "$dir" ]; do
        if [ -e "$dir/.git/HEAD" ]; then
            headfile="$dir/.git/HEAD"
            break
        fi
        dir="${dir%/*}"
    done
    
    if [ -e "$headfile" ]; then
        read -r head < "$headfile" || return
        case "$head" in
            ref:*) branch="${head##*/}" ;;
            "") branch="" ;;
            *) branch="${head:0:7}" ;;  # Detached HEAD
        esac
    fi
    
    if [ ! -z "$branch" ]; then
        # Optional dirty check (set BASHRC_SKIP_GIT_DIRTY=1 for max speed)
        if [ -z "$BASHRC_SKIP_GIT_DIRTY" ]; then
            local dirty=""
            git diff --quiet 2>/dev/null || dirty="*"
            git diff --cached --quiet 2>/dev/null || dirty+="+" 
            git_info=" git:($branch${dirty})"
        else
            git_info=" git:($branch)"
        fi
    fi
}

# Build prompt (optimized for Linux)
build_prompt() {
    PS1='\[\e[0;94m\]\u\[\e[0;90m\]@\[\e[0;94m\]\h\[\e[0m\] \[\e[0;37m\]\w\[\e[0m\]'
    
    [ -n "$git_info" ] && PS1+="\[\e[0;33m\]${git_info}\[\e[0m\]"
    PS1+='\n\[\e[0;90m\]$ \[\e[0m\]'
    
    [ "$TERM" = "xterm" ] && PS1="\[\e]0;\u@\h: \w\a\]$PS1"
}

PROMPT_COMMAND="get_system_stats; build_prompt"

# Bash inline autosuggestions (Linux optimized with readline enhancements)

# Enable better readline behavior
bind 'set show-all-if-ambiguous on'
bind 'set completion-ignore-case on'
bind 'set colored-stats on'
bind 'set visible-stats on'
bind 'set mark-symlinked-directories on'
bind 'set colored-completion-prefix on'
bind 'set menu-complete-display-prefix on'

# Bind arrow keys for prefix-based history search
bind '"\e[A": history-search-backward'
bind '"\e[B": history-search-forward'

# Bind Right arrow and Ctrl+F to move forward
bind '"\e[C": forward-char'
bind '"\C-f": forward-word'
bind '"\e[F": end-of-line'  # End key

# Use fzf for Ctrl+R if available (fuzzy history search)
if command -v fzf &> /dev/null; then
    bind '"\C-r": "\C-x\C-r"'
    bind -x '"\C-x\C-r": __fzf_history'

    __fzf_history() {
        local selected
        selected=$(
            HISTTIMEFORMAT= history |
            fzf --tac --no-sort --height 40% --reverse \
                --query "$READLINE_LINE" \
                --preview 'echo {}' --preview-window down:3:wrap |
            sed 's/^[ ]*[0-9]*[ ]*//'
        )
        if [ -n "$selected" ]; then
            READLINE_LINE="$selected"
            READLINE_POINT=${#READLINE_LINE}
        fi
    }
fi

# Colors & tools (enable colored output)
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
fi
alias ls='ls --color=auto'
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# System aliases (Linux-friendly navigation)
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias home='cd ~'
alias -- -='cd -'

# Listing aliases (enhanced file viewing)
alias ll='ls -alFh'
alias la='ls -A'
alias l='ls -CF'
alias lt='ls -alFht'
alias lsize='ls -alFhS'

# Safety aliases (prevent accidental file operations)
alias cp='cp -i'
alias mv='mv -i'
alias rm='rm -I --preserve-root'
alias mkdir='mkdir -p'

# System info aliases
alias h='history'
alias c='clear'
alias q='exit'

# System monitoring (Linux-specific)
alias free='free -h'
alias df='df -h'
alias du='du -h'
alias ps='ps aux'

# Networking aliases
alias myip='curl -s https://ipinfo.io/ip'
alias ports='netstat -tulanp'
alias listening='netstat -tulanp | grep LISTEN'

# Git aliases (essential commands for fast Git workflow)
alias g='git'
alias gs='git status -sb'
alias ga='git add'
alias gaa='git add --all'
alias gc='git commit'
alias gcm='git commit -m'
alias gca='git commit --amend'
alias gcan='git commit --amend --no-edit'
alias gp='git push'
alias gpf='git push --force-with-lease'
alias gpl='git pull'
alias gf='git fetch'
alias gl='git log --oneline --graph --decorate -10'
alias gd='git diff'
alias gb='git branch'
alias gco='git checkout'
alias gcb='git checkout -b'

# Advanced git aliases (workflow shortcuts)
alias wip='git add --all && git commit -m "WIP: work in progress"'
alias undo='git reset --soft HEAD~'
alias melt='git add --all && git commit --amend --no-edit'
alias nuke='git reset --hard && git clean -fd'

# Docker aliases (container management)
alias d='docker'
alias dc='docker compose'
alias dps='docker ps'
alias dpsa='docker ps -a'
alias di='docker images'

# Python aliases (Python development shortcuts)
alias py='python3'
alias pip='pip3'
alias venv='python3 -m venv'

# Node/NPM aliases (Node.js development shortcuts)
alias ni='npm install'
alias nr='npm run'
alias ns='npm start'

# Functions (essential utility functions)

# Make directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Simple extract function (supports common archive formats)
extract() {
    case "$1" in
        *.tar.gz|*.tgz) tar xzf "$1" ;;
        *.tar.bz2|*.tbz2) tar xjf "$1" ;;
        *.tar.xz) tar xJf "$1" ;;
        *.zip) unzip "$1" ;;
        *.7z) 7z x "$1" ;;
        *.rar) unrar x "$1" ;;
        *) echo "Unsupported format: $1" ;;
    esac
}

# Search in history (case-insensitive grep)
hgrep() {
    history | grep -i "$@"
}

# Completion (bash completion support)
if ! shopt -oq posix; then
    if [ -f /usr/share/bash-completion/bash_completion ]; then
        . /usr/share/bash-completion/bash_completion
    elif [ -f /etc/bash_completion ]; then
        . /etc/bash_completion
    fi
fi

# External sources (load user-specific configurations)
[ -f ~/.bash_aliases ] && . ~/.bash_aliases
[ -f ~/.bash_local ] && . ~/.bash_local

# Performance tip: Set this variable to skip git dirty check for faster prompts
# export BASHRC_SKIP_GIT_DIRTY=1